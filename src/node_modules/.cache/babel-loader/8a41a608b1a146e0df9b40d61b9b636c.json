{"ast":null,"code":"var _jsxFileName = \"/home/alexemdesgagne/octopus-telemetry/src/src/components/ImageViewer.tsx\",\n    _s = $RefreshSig$();\n\nimport { useCallback, useContext, useState, useRef } from 'react';\nimport { GeneralContext } from \"../context/generalContext\";\nimport Select from './common/select/Select';\nimport FormControl from './common/Form/FormControl';\nimport InputLabel from './common/Input/InputLabel';\nimport Button from './common/button/Button';\nimport { MPlayCircleFilledIcon as PlayCircleFilledIcon } from './common/Icons/Icon';\nimport { MStopIcon as StopIcon } from './common/Icons/Icon';\nimport { MCachedIcon as CachedIcon } from './common/Icons/Icon';\nimport { RosContext } from \"../context/rosContext\";\nimport { useROSService, ServiceRequestFactory, TopicFactory } from '../hooks/useROSService';\nimport jpeg from 'jpeg-js';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nconst ImageViewer = () => {\n  _s();\n\n  // Function to convert uncompressed data rgb8 to compressed base 64 jpeg\n  function rgb8ImageToBase64Jpeg(msg) {\n    var raw = atob(msg.data);\n    var array = new Uint8Array(new ArrayBuffer(raw.length));\n\n    for (let i = 0; i < raw.length; i++) {\n      array[i] = raw.charCodeAt(i);\n    }\n\n    var frameData = Buffer.alloc(msg.width * msg.height * 4);\n\n    for (let i = 0; i < msg.width * msg.height; i++) {\n      frameData[4 * i + 0] = array[3 * i + 0];\n      frameData[4 * i + 1] = array[3 * i + 1];\n      frameData[4 * i + 2] = array[3 * i + 2];\n      frameData[4 * i + 3] = 0;\n    }\n\n    var rawImageData = {\n      data: frameData,\n      width: msg.width,\n      height: msg.height\n    };\n    return jpeg.encode(rawImageData, 50).data.toString('base64');\n  }\n\n  const ros = useContext(RosContext);\n  const [topic, setTopic] = useState(null);\n  const [listTopic, setListTopic] = useState([]);\n  const topicRef = useRef(null);\n  const [image, setImage] = useState('');\n  const imageCallback = useCallback(x => {\n    var im;\n    if (x.encoding === \"bgr8\" || x.encoding === \"rgb8\") im = \"data:image/jpeg;base64,\" + rgb8ImageToBase64Jpeg(x);else if (x.format.includes(\"jpeg\")) im = \"data:image/jpeg;base64,\" + x.data;else {\n      window.alert(\"Video format (\" + x.encoding + \") is not supported, make sure you have the right encoding type or add it to the list\");\n\n      if (topicRef.current) {\n        topicRef.current.unsubscribe();\n        setTopic(null);\n      }\n    }\n    setImage(im);\n  }, []);\n\n  const handleChange = x => {\n    if (topic) {\n      topic.unsubscribe();\n    }\n\n    if (x.target.value !== \"None\") {\n      listTopic.forEach(value => {\n        if (value[\"value\"] === x.target.value) {\n          const type = value[\"type\"];\n          const newtopic = TopicFactory({\n            ros: ros,\n            name: x.target.value,\n            messageType: type\n          });\n          setTopic(newtopic);\n          topicRef.current = newtopic;\n\n          if (newtopic) {\n            newtopic.subscribe(imageCallback);\n          }\n        }\n      });\n    }\n  };\n\n  const clickStop = () => {\n    if (topic) {\n      topic.unsubscribe();\n    }\n  };\n\n  const clickPlay = () => {\n    if (topic) {\n      topic.subscribe(imageCallback);\n    }\n  };\n\n  const serviceCallback = useCallback(x => {\n    //Filtre sur les types de message que le souhaite \n    const messageFilter = [\"sensor_msgs/CompressedImage\", \"sensor_msgs/Image\"];\n    var tab = [];\n    x.topics.forEach((value, index) => {\n      if (messageFilter.includes(x.types[index])) {\n        const obj = {\n          value: value,\n          type: x.types[index]\n        };\n        tab.push(obj);\n      }\n    });\n    setListTopic(tab);\n  }, []);\n  const topicServiceCall = useROSService(serviceCallback, \"/rosapi/topics/\", \"rosapi/Topics\");\n\n  const clickUpdate = () => {\n    var request = ServiceRequestFactory({});\n    topicServiceCall(request);\n  };\n\n  return /*#__PURE__*/_jsxDEV(GeneralContext.Consumer, {\n    children: context => context && /*#__PURE__*/_jsxDEV(\"div\", {\n      style: {\n        width: '100%',\n        height: '100%'\n      },\n      children: /*#__PURE__*/_jsxDEV(\"div\", {\n        style: {\n          width: '96%',\n          height: '90%',\n          flexDirection: 'row',\n          marginLeft: '2%'\n        },\n        children: [/*#__PURE__*/_jsxDEV(\"h1\", {\n          style: {\n            fontSize: '20px',\n            textAlign: 'center'\n          },\n          children: \"CAMERA VIEWER\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 130,\n          columnNumber: 25\n        }, this), /*#__PURE__*/_jsxDEV(FormControl, {\n          children: [/*#__PURE__*/_jsxDEV(InputLabel, {\n            id: \"select-outlined-label\",\n            children: \"Topic\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 132,\n            columnNumber: 29\n          }, this), /*#__PURE__*/_jsxDEV(Select, {\n            labelId: \"select-outlined-label\",\n            id: \"select-outlined\",\n            handlerChange: handleChange,\n            label: \"Topic\",\n            value: (topic === null || topic === void 0 ? void 0 : topic.name) ? topic.name : \"None\",\n            style: {\n              backgroundColor: 'white'\n            },\n            listValue: listTopic\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 133,\n            columnNumber: 29\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 131,\n          columnNumber: 25\n        }, this), /*#__PURE__*/_jsxDEV(Button, {\n          label: /*#__PURE__*/_jsxDEV(CachedIcon, {}, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 145,\n            columnNumber: 36\n          }, this),\n          handler: clickUpdate,\n          isIcon: true\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 144,\n          columnNumber: 25\n        }, this), /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 149,\n          columnNumber: 25\n        }, this), /*#__PURE__*/_jsxDEV(Button, {\n          label: /*#__PURE__*/_jsxDEV(StopIcon, {}, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 151,\n            columnNumber: 36\n          }, this),\n          handler: clickStop,\n          isIcon: true\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 150,\n          columnNumber: 25\n        }, this), /*#__PURE__*/_jsxDEV(Button, {\n          label: /*#__PURE__*/_jsxDEV(PlayCircleFilledIcon, {}, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 156,\n            columnNumber: 36\n          }, this),\n          handler: clickPlay,\n          isIcon: true\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 155,\n          columnNumber: 25\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          style: {\n            width: \"100%\",\n            height: \"calc(100% - 140px)\"\n          },\n          children: image !== '' ? /*#__PURE__*/_jsxDEV(\"img\", {\n            src: image,\n            width: \"100%\",\n            height: \"100%\",\n            alt: \"imageviewer\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 162,\n            columnNumber: 33\n          }, this) : /*#__PURE__*/_jsxDEV(\"img\", {\n            width: \"100%\",\n            height: \"100%\",\n            alt: \"imageviewer\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 162,\n            columnNumber: 104\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 160,\n          columnNumber: 25\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 129,\n        columnNumber: 21\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 128,\n      columnNumber: 17\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 126,\n    columnNumber: 9\n  }, this);\n};\n\n_s(ImageViewer, \"Da4XkDa5dnAVkSgJpuUzndUHBaw=\", false, function () {\n  return [useROSService];\n});\n\n_c = ImageViewer;\nexport default ImageViewer;\n\nvar _c;\n\n$RefreshReg$(_c, \"ImageViewer\");","map":{"version":3,"sources":["/home/alexemdesgagne/octopus-telemetry/src/src/components/ImageViewer.tsx"],"names":["useCallback","useContext","useState","useRef","GeneralContext","Select","FormControl","InputLabel","Button","MPlayCircleFilledIcon","PlayCircleFilledIcon","MStopIcon","StopIcon","MCachedIcon","CachedIcon","RosContext","useROSService","ServiceRequestFactory","TopicFactory","jpeg","ImageViewer","rgb8ImageToBase64Jpeg","msg","raw","atob","data","array","Uint8Array","ArrayBuffer","length","i","charCodeAt","frameData","Buffer","alloc","width","height","rawImageData","encode","toString","ros","topic","setTopic","listTopic","setListTopic","topicRef","image","setImage","imageCallback","x","im","encoding","format","includes","window","alert","current","unsubscribe","handleChange","target","value","forEach","type","newtopic","name","messageType","subscribe","clickStop","clickPlay","serviceCallback","messageFilter","tab","topics","index","types","obj","push","topicServiceCall","clickUpdate","request","context","flexDirection","marginLeft","fontSize","textAlign","backgroundColor"],"mappings":"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","sourcesContent":["import { useCallback, useContext, useState, useRef } from 'react';\nimport { GeneralContext } from \"../context/generalContext\";\n\nimport Select from './common/select/Select';\nimport FormControl from './common/Form/FormControl';\nimport InputLabel from './common/Input/InputLabel';\nimport Button from './common/button/Button'\n\nimport { MPlayCircleFilledIcon as PlayCircleFilledIcon } from './common/Icons/Icon';\nimport { MStopIcon as StopIcon } from './common/Icons/Icon';\nimport { MCachedIcon as CachedIcon } from './common/Icons/Icon';\n\nimport { RosContext } from \"../context/rosContext\";\nimport { useROSService, ServiceRequestFactory, Topic, TopicFactory } from '../hooks/useROSService'\n\nimport jpeg from 'jpeg-js'\n\nconst ImageViewer = () => {\n\n    // Function to convert uncompressed data rgb8 to compressed base 64 jpeg\n    function rgb8ImageToBase64Jpeg(msg: any) {\n        var raw = atob(msg.data)\n        var array = new Uint8Array(new ArrayBuffer(raw.length))\n        for (let i = 0; i < raw.length; i++) {\n            array[i] = raw.charCodeAt(i)\n        }\n\n        var frameData = Buffer.alloc(msg.width * msg.height * 4)\n        for (let i = 0; i < msg.width * msg.height; i++) {\n            frameData[4 * i + 0] = array[3 * i + 0]\n            frameData[4 * i + 1] = array[3 * i + 1]\n            frameData[4 * i + 2] = array[3 * i + 2]\n            frameData[4 * i + 3] = 0\n        }\n        var rawImageData = {\n            data: frameData,\n            width: msg.width,\n            height: msg.height\n        }\n        return jpeg.encode(rawImageData, 50).data.toString('base64')\n    }\n\n    const ros = useContext(RosContext);\n\n    const [topic, setTopic] = useState<Topic | null>(null);\n    const [listTopic, setListTopic] = useState<[]>([]);\n    const topicRef = useRef<Topic | null>(null);\n    const [image, setImage] = useState('')\n\n    const imageCallback = useCallback(\n        (x: any) => {\n\n            var im: any;\n            if (x.encoding === \"bgr8\" || x.encoding === \"rgb8\")\n                im = \"data:image/jpeg;base64,\" + rgb8ImageToBase64Jpeg(x);\n            else if (x.format.includes(\"jpeg\"))\n                im = \"data:image/jpeg;base64,\" + x.data;\n            else {\n                window.alert(\"Video format (\" + x.encoding + \") is not supported, make sure you have the right encoding type or add it to the list\");\n                if (topicRef.current) {\n                    topicRef.current.unsubscribe()\n                    setTopic(null)\n                }\n            }\n            setImage(im)\n        },\n        []\n    )\n\n    const handleChange = (x: any) => {\n        if (topic) {\n            topic.unsubscribe()\n        }\n        if (x.target.value !== \"None\") {\n            listTopic.forEach((value) => {\n                if (value[\"value\"] === x.target.value) {\n                    const type = value[\"type\"]\n                    const newtopic = TopicFactory({ ros: ros, name: x.target.value, messageType: type })\n                    setTopic(newtopic)\n                    topicRef.current = newtopic;\n                    if (newtopic) {\n                        newtopic.subscribe(imageCallback);\n                    }\n                }\n            })\n        }\n    }\n\n    const clickStop = () => {\n        if (topic) {\n            topic.unsubscribe()\n        }\n    }\n\n    const clickPlay = () => {\n        if (topic) {\n            topic.subscribe(imageCallback);\n        }\n    }\n\n    const serviceCallback = useCallback(\n        (x: any) => {\n\n            //Filtre sur les types de message que le souhaite \n            const messageFilter = [\"sensor_msgs/CompressedImage\", \"sensor_msgs/Image\"]\n\n            var tab: any = []\n            x.topics.forEach((value: any, index: any) => {\n                if (messageFilter.includes(x.types[index])) {\n                    const obj = { value: value, type: x.types[index] }\n                    tab.push(obj);\n                }\n            })\n            setListTopic(tab)\n        }, []\n    )\n\n    const topicServiceCall = useROSService<any>(serviceCallback, \"/rosapi/topics/\", \"rosapi/Topics\")\n\n    const clickUpdate = () => {\n        var request = ServiceRequestFactory({});\n        topicServiceCall(request)\n    }\n\n    return (\n        <GeneralContext.Consumer>\n            {context => context && (\n                <div style={{ width: '100%', height: '100%' }}>\n                    <div style={{ width: '96%', height: '90%', flexDirection: 'row', marginLeft: '2%' }}>\n                        <h1 style={{ fontSize: '20px', textAlign: 'center' }}>CAMERA VIEWER</h1>\n                        <FormControl>\n                            <InputLabel id=\"select-outlined-label\">Topic</InputLabel>\n                            <Select\n                                labelId=\"select-outlined-label\"\n                                id=\"select-outlined\"\n                                handlerChange={handleChange}\n                                label=\"Topic\"\n                                value={topic?.name ? topic.name : \"None\"}\n                                style={{ backgroundColor: 'white' }}\n                                listValue={listTopic}\n                            >\n                            </Select>\n                        </FormControl>\n                        <Button\n                            label={<CachedIcon />}\n                            handler={clickUpdate}\n                            isIcon={true}\n                        ></Button>\n                        <br></br>\n                        <Button\n                            label={<StopIcon />}\n                            handler={clickStop}\n                            isIcon={true}\n                        ></Button>\n                        <Button\n                            label={<PlayCircleFilledIcon />}\n                            handler={clickPlay}\n                            isIcon={true}\n                        ></Button>\n                        <div style={{ width: \"100%\", height: \"calc(100% - 140px)\" }}>\n                            {image !== '' ?\n                                <img src={image} width=\"100%\" height=\"100%\" alt=\"imageviewer\"></img> : <img width=\"100%\" height=\"100%\" alt=\"imageviewer\"></img>\n                            }\n                        </div>\n                    </div>\n                </div>\n            )}\n        </GeneralContext.Consumer>\n    );\n};\n\nexport default ImageViewer;"]},"metadata":{},"sourceType":"module"}